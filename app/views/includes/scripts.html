<script src="/js/main.js"></script>
{% if useAutoStoreData %}
  <script src="/js/auto-store-data.js"></script>
{% endif %}

<!-- Add any custom scripts -->
{% if page.scripts.compressedFlowTransition == true %}

<script>
(function () {
  // --- Config attribute names ---
  var MESSAGE_ATTR = 'data-transition-message';
  var DELAY_ATTR   = 'data-transition-delay'; // seconds

  // --- Inject CSS for fade-to-black + message overlay ---
  function injectTransitionStyles() {
    if (document.getElementById('page-transition-fade-style')) return;

    var style = document.createElement('style');
    style.id = 'page-transition-fade-style';
    style.textContent = `
      .page-transition-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.9);
        opacity: 0;
        pointer-events: none;
        z-index: 2147483647;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 1.5rem;
        box-sizing: border-box;
        transition: opacity 0.5s ease;
      }

      .page-transition-overlay--visible {
        opacity: 1;
      }

      .page-transition-overlay__text {
        color: #fff;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 2.25rem;
        line-height: 1.4;
      }

      @media (prefers-reduced-motion: reduce) {
        .page-transition-overlay {
          transition: opacity 0.01s linear;
        }
      }
    `;
    document.head.appendChild(style);
  }

  // Look up message / delay starting from sourceEl and walking up to <body>, then fallback to <body>
  function getTransitionConfig(sourceEl) {
    var body = document.body;
    function lookup(attr) {
      var el = sourceEl;
      while (el) {
        if (el.hasAttribute && el.hasAttribute(attr)) {
          return el.getAttribute(attr);
        }
        if (el === body) break;
        el = el.parentElement;
      }
      return body.getAttribute(attr);
    }

    var msg = lookup(MESSAGE_ATTR) || '';
    var delayRaw = lookup(DELAY_ATTR);
    var delay = parseFloat(delayRaw);
    if (!isFinite(delay) || delay < 0) delay = 0;

    return { message: msg, delaySeconds: delay };
  }

  function init() {
    if (!document.body || document.body.dataset.pageTransitionFadeInit === 'true') return;
    document.body.dataset.pageTransitionFadeInit = 'true';

    injectTransitionStyles();

    // Global flags (any element in the DOM with these attrs)
    var disableEntry = document.querySelector('[data-no-entry-transition]') !== null;
    var disableExit  = document.querySelector('[data-no-exit-transition]')  !== null;

    // --- Create overlay once per page ---
    var overlay = document.createElement('div');
    overlay.id = 'page-transition-overlay';
    overlay.className = 'page-transition-overlay';

    var textEl = document.createElement('div');
    textEl.className = 'page-transition-overlay__text';
    overlay.appendChild(textEl);

    document.body.appendChild(overlay);

    // --- ENTRY: fade in from black on load / bfcache ---
    function playEntryFade() {
      if (disableEntry) return;

      // Start fully black instantly
      overlay.classList.add('page-transition-overlay--visible');
      overlay.style.transition = 'none';

      requestAnimationFrame(function () {
        // Re-enable transition and fade to transparent
        overlay.style.transition = '';
        overlay.classList.remove('page-transition-overlay--visible');
      });
    }

    // Initial entry fade
    playEntryFade();

    // --- EXIT: fade to black, show message, hold, then run action (navigate/submit) ---
    function runWithExitTransition(action, sourceEl) {
      // If exit transitions are globally disabled, just perform the action immediately
      if (disableExit) {
        action();
        return;
      }

      var cfg = getTransitionConfig(sourceEl || document.body);
      textEl.textContent = cfg.message || '';

      // Ensure we start from transparent
      overlay.classList.remove('page-transition-overlay--visible');
      void overlay.offsetWidth; // force reflow

      overlay.classList.add('page-transition-overlay--visible');

      var computed = getComputedStyle(overlay);
      var dur = parseFloat(computed.transitionDuration) || 0;
      var delay = parseFloat(computed.transitionDelay) || 0;
      var fadeMs = (dur + delay) * 1000;

      // After fade-to-black finishes, hold for cfg.delaySeconds, then act
      setTimeout(function () {
        setTimeout(function () {
          action();
        }, cfg.delaySeconds * 1000);
      }, fadeMs);
    }

    // --- LINK HANDLER ---
    document.addEventListener('click', function (e) {
      // If exit transitions are disabled globally, don't intercept at all
      if (disableExit) return;

      var link = e.target.closest && e.target.closest('a');
      if (!link) return;

      // Ignore new-tab / external behaviours
      if (
        link.target === '_blank' ||
        link.hasAttribute('download') ||
        (link.rel || '').includes('external') ||
        (link.href && (link.href.startsWith('mailto:') || link.href.startsWith('tel:')))
      ) {
        return;
      }

      if (!link.href || link.origin !== window.location.origin) return;

      var base = function (url) { return url.split('#')[0]; };
      if (base(window.location.href) === base(link.href)) return;

      e.preventDefault();

      runWithExitTransition(function () {
        window.location.href = link.href;
      }, link);
    });

    // --- FORM HANDLER ---
    document.addEventListener('submit', function (e) {
      var form = e.target;
      if (!(form instanceof HTMLFormElement)) return;

      // If exit transitions are disabled, don't touch the form:
      // let the browser submit it normally.
      if (disableExit) {
        return;
      }

      if (form.target && form.target !== '_self') return;

      e.preventDefault();

      runWithExitTransition(function () {
        form.submit();
      }, form);
    });

    // --- BFCACHE entry (back/forward) ---
    window.addEventListener('pageshow', function (event) {
      if (event.persisted) {
        playEntryFade();
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>


  {# <script>
  (function () {
    // --- Config attribute names ---
    var MESSAGE_ATTR = 'data-transition-message';
    var DELAY_ATTR   = 'data-transition-delay'; // seconds

    // --- Inject CSS for fade-to-black + message overlay ---
    function injectTransitionStyles() {
      if (document.getElementById('page-transition-fade-style')) return;

      var style = document.createElement('style');
      style.id = 'page-transition-fade-style';
      style.textContent = `
        .page-transition-overlay {
          position: fixed;
          inset: 0;
          background: #000;
          opacity: 0;
          pointer-events: none;
          z-index: 2147483647;
          display: flex;
          align-items: center;
          justify-content: center;
          text-align: center;
          padding: 1.5rem;
          box-sizing: border-box;
          transition: opacity 0.5s ease;
        }

        .page-transition-overlay--visible {
          opacity: 1;
        }

        .page-transition-overlay__text {
          color: #fff;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          font-size: 2.35rem;
          line-height: 1.4;
        }

        /* Avoid huge flashes for users who prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
          .page-transition-overlay {
            transition: opacity 0.01s linear;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Look up message / delay starting from sourceEl and walking up to <body>, then fallback to <body>
    function getTransitionConfig(sourceEl) {
      var body = document.body;
      function lookup(attr) {
        var el = sourceEl;
        while (el) {
          if (el.hasAttribute && el.hasAttribute(attr)) {
            return el.getAttribute(attr);
          }
          if (el === body) break;
          el = el.parentElement;
        }
        return body.getAttribute(attr);
      }

      var msg = lookup(MESSAGE_ATTR) || '';
      var delayRaw = lookup(DELAY_ATTR);
      var delay = parseFloat(delayRaw);
      if (!isFinite(delay) || delay < 0) delay = 0;

      return { message: msg, delaySeconds: delay };
    }

    function init() {
      if (!document.body || document.body.dataset.pageTransitionFadeInit === 'true') return;
      document.body.dataset.pageTransitionFadeInit = 'true';

      injectTransitionStyles();

      var disableEntry = document.querySelector('[data-no-entry-transition]') !== null;
      var disableExit  = document.querySelector('[data-no-exit-transition]')  !== null;

      // --- Create overlay once per page ---
      var overlay = document.createElement('div');
      overlay.id = 'page-transition-overlay';
      overlay.className = 'page-transition-overlay';

      var textEl = document.createElement('div');
      textEl.className = 'page-transition-overlay__text';
      overlay.appendChild(textEl);

      document.body.appendChild(overlay);

      // --- ENTRY: fade in from black on load / bfcache ---
      function playEntryFade() {
        if (disableEntry) return;

        // Start fully black instantly, then fade out
        overlay.classList.add('page-transition-overlay--visible');
        overlay.style.transition = 'none';

        requestAnimationFrame(function () {
          // Re-enable transition and fade from black to transparent
          overlay.style.transition = '';
          overlay.classList.remove('page-transition-overlay--visible');
        });
      }

      // Initial entry fade
      playEntryFade();

      // --- EXIT: fade to black, show message, hold, then run action (navigate/submit) ---
      function runWithExitTransition(action, sourceEl) {
        if (disableExit) {
          action();
          return;
        }

        var cfg = getTransitionConfig(sourceEl || document.body);
        textEl.textContent = cfg.message || '';

        // Ensure we start from transparent
        overlay.classList.remove('page-transition-overlay--visible');
        // Force reflow so the next class change transitions
        void overlay.offsetWidth;

        overlay.classList.add('page-transition-overlay--visible');

        var computed = getComputedStyle(overlay);
        var dur = parseFloat(computed.transitionDuration) || 0;
        var delay = parseFloat(computed.transitionDelay) || 0;
        var fadeMs = (dur + delay) * 1000;

        // After fade-to-black finishes, hold for cfg.delaySeconds, then act
        setTimeout(function () {
          setTimeout(function () {
            action();
          }, cfg.delaySeconds * 1000);
        }, fadeMs);
      }

      // --- LINK HANDLER ---
      document.addEventListener('click', function (e) {
        var link = e.target.closest && e.target.closest('a');
        if (!link) return;

        // Ignore new-tab / external behaviours
        if (
          link.target === '_blank' ||
          link.hasAttribute('download') ||
          (link.rel || '').includes('external') ||
          (link.href && (link.href.startsWith('mailto:') || link.href.startsWith('tel:')))
        ) {
          return;
        }

        if (!link.href || link.origin !== window.location.origin) return;

        var base = function (url) { return url.split('#')[0]; };
        if (base(window.location.href) === base(link.href)) return;

        e.preventDefault();

        runWithExitTransition(function () {
          window.location.href = link.href;
        }, link);
      });

      // --- FORM HANDLER ---
      document.addEventListener('submit', function (e) {
        var form = e.target;
        if (!(form instanceof HTMLFormElement)) return;

        if (form.target && form.target !== '_self') return;

        e.preventDefault();

        runWithExitTransition(function () {
          form.submit();
        }, form);
      });

      // --- BFCACHE entry (back/forward) ---
      window.addEventListener('pageshow', function (event) {
        if (event.persisted) {
          playEntryFade();
        }
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script> #}

{% endif %}
